{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CommandOperation = void 0;\n\nconst error_1 = require(\"../error\");\n\nconst explain_1 = require(\"../explain\");\n\nconst read_concern_1 = require(\"../read_concern\");\n\nconst server_selection_1 = require(\"../sdam/server_selection\");\n\nconst utils_1 = require(\"../utils\");\n\nconst write_concern_1 = require(\"../write_concern\");\n\nconst operation_1 = require(\"./operation\");\n\nconst SUPPORTS_WRITE_CONCERN_AND_COLLATION = 5;\n/** @internal */\n\nclass CommandOperation extends operation_1.AbstractOperation {\n  constructor(parent, options) {\n    super(options);\n    this.options = options !== null && options !== void 0 ? options : {}; // NOTE: this was explicitly added for the add/remove user operations, it's likely\n    //       something we'd want to reconsider. Perhaps those commands can use `Admin`\n    //       as a parent?\n\n    const dbNameOverride = (options === null || options === void 0 ? void 0 : options.dbName) || (options === null || options === void 0 ? void 0 : options.authdb);\n\n    if (dbNameOverride) {\n      this.ns = new utils_1.MongoDBNamespace(dbNameOverride, '$cmd');\n    } else {\n      this.ns = parent ? parent.s.namespace.withCollection('$cmd') : new utils_1.MongoDBNamespace('admin', '$cmd');\n    }\n\n    this.readConcern = read_concern_1.ReadConcern.fromOptions(options);\n    this.writeConcern = write_concern_1.WriteConcern.fromOptions(options); // TODO(NODE-2056): make logger another \"inheritable\" property\n\n    if (parent && parent.logger) {\n      this.logger = parent.logger;\n    }\n\n    if (this.hasAspect(operation_1.Aspect.EXPLAINABLE)) {\n      this.explain = explain_1.Explain.fromOptions(options);\n    } else if ((options === null || options === void 0 ? void 0 : options.explain) != null) {\n      throw new error_1.MongoInvalidArgumentError(`Option \"explain\" is not supported on this command`);\n    }\n  }\n\n  get canRetryWrite() {\n    if (this.hasAspect(operation_1.Aspect.EXPLAINABLE)) {\n      return this.explain == null;\n    }\n\n    return true;\n  }\n\n  executeCommand(server, session, cmd, callback) {\n    // TODO: consider making this a non-enumerable property\n    this.server = server;\n    const options = { ...this.options,\n      ...this.bsonOptions,\n      readPreference: this.readPreference,\n      session\n    };\n    const serverWireVersion = (0, utils_1.maxWireVersion)(server);\n    const inTransaction = this.session && this.session.inTransaction();\n\n    if (this.readConcern && (0, utils_1.commandSupportsReadConcern)(cmd) && !inTransaction) {\n      Object.assign(cmd, {\n        readConcern: this.readConcern\n      });\n    }\n\n    if (this.trySecondaryWrite && serverWireVersion < server_selection_1.MIN_SECONDARY_WRITE_WIRE_VERSION) {\n      options.omitReadPreference = true;\n    }\n\n    if (options.collation && serverWireVersion < SUPPORTS_WRITE_CONCERN_AND_COLLATION) {\n      callback(new error_1.MongoCompatibilityError(`Server ${server.name}, which reports wire version ${serverWireVersion}, does not support collation`));\n      return;\n    }\n\n    if (this.writeConcern && this.hasAspect(operation_1.Aspect.WRITE_OPERATION) && !inTransaction) {\n      Object.assign(cmd, {\n        writeConcern: this.writeConcern\n      });\n    }\n\n    if (serverWireVersion >= SUPPORTS_WRITE_CONCERN_AND_COLLATION) {\n      if (options.collation && typeof options.collation === 'object' && !this.hasAspect(operation_1.Aspect.SKIP_COLLATION)) {\n        Object.assign(cmd, {\n          collation: options.collation\n        });\n      }\n    }\n\n    if (typeof options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = options.maxTimeMS;\n    }\n\n    if (this.hasAspect(operation_1.Aspect.EXPLAINABLE) && this.explain) {\n      if (serverWireVersion < 6 && cmd.aggregate) {\n        // Prior to 3.6, with aggregate, verbosity is ignored, and we must pass in \"explain: true\"\n        cmd.explain = true;\n      } else {\n        cmd = (0, utils_1.decorateWithExplain)(cmd, this.explain);\n      }\n    }\n\n    server.command(this.ns, cmd, options, callback);\n  }\n\n}\n\nexports.CommandOperation = CommandOperation;","map":{"version":3,"sources":["../../src/operations/command.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.CommandOperation = void 0;\nconst error_1 = require(\"../error\");\nconst explain_1 = require(\"../explain\");\nconst read_concern_1 = require(\"../read_concern\");\nconst server_selection_1 = require(\"../sdam/server_selection\");\nconst utils_1 = require(\"../utils\");\nconst write_concern_1 = require(\"../write_concern\");\nconst operation_1 = require(\"./operation\");\nconst SUPPORTS_WRITE_CONCERN_AND_COLLATION = 5;\n/** @internal */\nclass CommandOperation extends operation_1.AbstractOperation {\n    constructor(parent, options) {\n        super(options);\n        this.options = options !== null && options !== void 0 ? options : {};\n        // NOTE: this was explicitly added for the add/remove user operations, it's likely\n        //       something we'd want to reconsider. Perhaps those commands can use `Admin`\n        //       as a parent?\n        const dbNameOverride = (options === null || options === void 0 ? void 0 : options.dbName) || (options === null || options === void 0 ? void 0 : options.authdb);\n        if (dbNameOverride) {\n            this.ns = new utils_1.MongoDBNamespace(dbNameOverride, '$cmd');\n        }\n        else {\n            this.ns = parent\n                ? parent.s.namespace.withCollection('$cmd')\n                : new utils_1.MongoDBNamespace('admin', '$cmd');\n        }\n        this.readConcern = read_concern_1.ReadConcern.fromOptions(options);\n        this.writeConcern = write_concern_1.WriteConcern.fromOptions(options);\n        // TODO(NODE-2056): make logger another \"inheritable\" property\n        if (parent && parent.logger) {\n            this.logger = parent.logger;\n        }\n        if (this.hasAspect(operation_1.Aspect.EXPLAINABLE)) {\n            this.explain = explain_1.Explain.fromOptions(options);\n        }\n        else if ((options === null || options === void 0 ? void 0 : options.explain) != null) {\n            throw new error_1.MongoInvalidArgumentError(`Option \"explain\" is not supported on this command`);\n        }\n    }\n    get canRetryWrite() {\n        if (this.hasAspect(operation_1.Aspect.EXPLAINABLE)) {\n            return this.explain == null;\n        }\n        return true;\n    }\n    executeCommand(server, session, cmd, callback) {\n        // TODO: consider making this a non-enumerable property\n        this.server = server;\n        const options = {\n            ...this.options,\n            ...this.bsonOptions,\n            readPreference: this.readPreference,\n            session\n        };\n        const serverWireVersion = (0, utils_1.maxWireVersion)(server);\n        const inTransaction = this.session && this.session.inTransaction();\n        if (this.readConcern && (0, utils_1.commandSupportsReadConcern)(cmd) && !inTransaction) {\n            Object.assign(cmd, { readConcern: this.readConcern });\n        }\n        if (this.trySecondaryWrite && serverWireVersion < server_selection_1.MIN_SECONDARY_WRITE_WIRE_VERSION) {\n            options.omitReadPreference = true;\n        }\n        if (options.collation && serverWireVersion < SUPPORTS_WRITE_CONCERN_AND_COLLATION) {\n            callback(new error_1.MongoCompatibilityError(`Server ${server.name}, which reports wire version ${serverWireVersion}, does not support collation`));\n            return;\n        }\n        if (this.writeConcern && this.hasAspect(operation_1.Aspect.WRITE_OPERATION) && !inTransaction) {\n            Object.assign(cmd, { writeConcern: this.writeConcern });\n        }\n        if (serverWireVersion >= SUPPORTS_WRITE_CONCERN_AND_COLLATION) {\n            if (options.collation &&\n                typeof options.collation === 'object' &&\n                !this.hasAspect(operation_1.Aspect.SKIP_COLLATION)) {\n                Object.assign(cmd, { collation: options.collation });\n            }\n        }\n        if (typeof options.maxTimeMS === 'number') {\n            cmd.maxTimeMS = options.maxTimeMS;\n        }\n        if (this.hasAspect(operation_1.Aspect.EXPLAINABLE) && this.explain) {\n            if (serverWireVersion < 6 && cmd.aggregate) {\n                // Prior to 3.6, with aggregate, verbosity is ignored, and we must pass in \"explain: true\"\n                cmd.explain = true;\n            }\n            else {\n                cmd = (0, utils_1.decorateWithExplain)(cmd, this.explain);\n            }\n        }\n        server.command(this.ns, cmd, options, callback);\n    }\n}\nexports.CommandOperation = CommandOperation;\n//# sourceMappingURL=command.js.map"]},"metadata":{},"sourceType":"script"}