{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.makeDeleteStatement = exports.DeleteManyOperation = exports.DeleteOneOperation = exports.DeleteOperation = void 0;\n\nconst error_1 = require(\"../error\");\n\nconst utils_1 = require(\"../utils\");\n\nconst command_1 = require(\"./command\");\n\nconst operation_1 = require(\"./operation\");\n/** @internal */\n\n\nclass DeleteOperation extends command_1.CommandOperation {\n  constructor(ns, statements, options) {\n    super(undefined, options);\n    this.options = options;\n    this.ns = ns;\n    this.statements = statements;\n  }\n\n  get canRetryWrite() {\n    if (super.canRetryWrite === false) {\n      return false;\n    }\n\n    return this.statements.every(op => op.limit != null ? op.limit > 0 : true);\n  }\n\n  execute(server, session, callback) {\n    var _a;\n\n    const options = (_a = this.options) !== null && _a !== void 0 ? _a : {};\n    const ordered = typeof options.ordered === 'boolean' ? options.ordered : true;\n    const command = {\n      delete: this.ns.collection,\n      deletes: this.statements,\n      ordered\n    };\n\n    if (options.let) {\n      command.let = options.let;\n    } // we check for undefined specifically here to allow falsy values\n    // eslint-disable-next-line no-restricted-syntax\n\n\n    if (options.comment !== undefined) {\n      command.comment = options.comment;\n    }\n\n    if (options.explain != null && (0, utils_1.maxWireVersion)(server) < 3) {\n      return callback ? callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support explain on delete`)) : undefined;\n    }\n\n    const unacknowledgedWrite = this.writeConcern && this.writeConcern.w === 0;\n\n    if (unacknowledgedWrite || (0, utils_1.maxWireVersion)(server) < 5) {\n      if (this.statements.find(o => o.hint)) {\n        callback(new error_1.MongoCompatibilityError(`Servers < 3.4 do not support hint on delete`));\n        return;\n      }\n    }\n\n    const statementWithCollation = this.statements.find(statement => !!statement.collation);\n\n    if (statementWithCollation && (0, utils_1.collationNotSupported)(server, statementWithCollation)) {\n      callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support collation`));\n      return;\n    }\n\n    super.executeCommand(server, session, command, callback);\n  }\n\n}\n\nexports.DeleteOperation = DeleteOperation;\n\nclass DeleteOneOperation extends DeleteOperation {\n  constructor(collection, filter, options) {\n    super(collection.s.namespace, [makeDeleteStatement(filter, { ...options,\n      limit: 1\n    })], options);\n  }\n\n  execute(server, session, callback) {\n    super.execute(server, session, (err, res) => {\n      var _a, _b;\n\n      if (err || res == null) return callback(err);\n      if (res.code) return callback(new error_1.MongoServerError(res));\n      if (res.writeErrors) return callback(new error_1.MongoServerError(res.writeErrors[0]));\n      if (this.explain) return callback(undefined, res);\n      callback(undefined, {\n        acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n        deletedCount: res.n\n      });\n    });\n  }\n\n}\n\nexports.DeleteOneOperation = DeleteOneOperation;\n\nclass DeleteManyOperation extends DeleteOperation {\n  constructor(collection, filter, options) {\n    super(collection.s.namespace, [makeDeleteStatement(filter, options)], options);\n  }\n\n  execute(server, session, callback) {\n    super.execute(server, session, (err, res) => {\n      var _a, _b;\n\n      if (err || res == null) return callback(err);\n      if (res.code) return callback(new error_1.MongoServerError(res));\n      if (res.writeErrors) return callback(new error_1.MongoServerError(res.writeErrors[0]));\n      if (this.explain) return callback(undefined, res);\n      callback(undefined, {\n        acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n        deletedCount: res.n\n      });\n    });\n  }\n\n}\n\nexports.DeleteManyOperation = DeleteManyOperation;\n\nfunction makeDeleteStatement(filter, options) {\n  const op = {\n    q: filter,\n    limit: typeof options.limit === 'number' ? options.limit : 0\n  };\n\n  if (options.single === true) {\n    op.limit = 1;\n  }\n\n  if (options.collation) {\n    op.collation = options.collation;\n  }\n\n  if (options.hint) {\n    op.hint = options.hint;\n  }\n\n  return op;\n}\n\nexports.makeDeleteStatement = makeDeleteStatement;\n(0, operation_1.defineAspects)(DeleteOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION]);\n(0, operation_1.defineAspects)(DeleteOneOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.SKIP_COLLATION]);\n(0, operation_1.defineAspects)(DeleteManyOperation, [operation_1.Aspect.WRITE_OPERATION, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.SKIP_COLLATION]);","map":{"version":3,"sources":["../../src/operations/delete.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.makeDeleteStatement = exports.DeleteManyOperation = exports.DeleteOneOperation = exports.DeleteOperation = void 0;\nconst error_1 = require(\"../error\");\nconst utils_1 = require(\"../utils\");\nconst command_1 = require(\"./command\");\nconst operation_1 = require(\"./operation\");\n/** @internal */\nclass DeleteOperation extends command_1.CommandOperation {\n    constructor(ns, statements, options) {\n        super(undefined, options);\n        this.options = options;\n        this.ns = ns;\n        this.statements = statements;\n    }\n    get canRetryWrite() {\n        if (super.canRetryWrite === false) {\n            return false;\n        }\n        return this.statements.every(op => (op.limit != null ? op.limit > 0 : true));\n    }\n    execute(server, session, callback) {\n        var _a;\n        const options = (_a = this.options) !== null && _a !== void 0 ? _a : {};\n        const ordered = typeof options.ordered === 'boolean' ? options.ordered : true;\n        const command = {\n            delete: this.ns.collection,\n            deletes: this.statements,\n            ordered\n        };\n        if (options.let) {\n            command.let = options.let;\n        }\n        // we check for undefined specifically here to allow falsy values\n        // eslint-disable-next-line no-restricted-syntax\n        if (options.comment !== undefined) {\n            command.comment = options.comment;\n        }\n        if (options.explain != null && (0, utils_1.maxWireVersion)(server) < 3) {\n            return callback\n                ? callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support explain on delete`))\n                : undefined;\n        }\n        const unacknowledgedWrite = this.writeConcern && this.writeConcern.w === 0;\n        if (unacknowledgedWrite || (0, utils_1.maxWireVersion)(server) < 5) {\n            if (this.statements.find((o) => o.hint)) {\n                callback(new error_1.MongoCompatibilityError(`Servers < 3.4 do not support hint on delete`));\n                return;\n            }\n        }\n        const statementWithCollation = this.statements.find(statement => !!statement.collation);\n        if (statementWithCollation && (0, utils_1.collationNotSupported)(server, statementWithCollation)) {\n            callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support collation`));\n            return;\n        }\n        super.executeCommand(server, session, command, callback);\n    }\n}\nexports.DeleteOperation = DeleteOperation;\nclass DeleteOneOperation extends DeleteOperation {\n    constructor(collection, filter, options) {\n        super(collection.s.namespace, [makeDeleteStatement(filter, { ...options, limit: 1 })], options);\n    }\n    execute(server, session, callback) {\n        super.execute(server, session, (err, res) => {\n            var _a, _b;\n            if (err || res == null)\n                return callback(err);\n            if (res.code)\n                return callback(new error_1.MongoServerError(res));\n            if (res.writeErrors)\n                return callback(new error_1.MongoServerError(res.writeErrors[0]));\n            if (this.explain)\n                return callback(undefined, res);\n            callback(undefined, {\n                acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n                deletedCount: res.n\n            });\n        });\n    }\n}\nexports.DeleteOneOperation = DeleteOneOperation;\nclass DeleteManyOperation extends DeleteOperation {\n    constructor(collection, filter, options) {\n        super(collection.s.namespace, [makeDeleteStatement(filter, options)], options);\n    }\n    execute(server, session, callback) {\n        super.execute(server, session, (err, res) => {\n            var _a, _b;\n            if (err || res == null)\n                return callback(err);\n            if (res.code)\n                return callback(new error_1.MongoServerError(res));\n            if (res.writeErrors)\n                return callback(new error_1.MongoServerError(res.writeErrors[0]));\n            if (this.explain)\n                return callback(undefined, res);\n            callback(undefined, {\n                acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n                deletedCount: res.n\n            });\n        });\n    }\n}\nexports.DeleteManyOperation = DeleteManyOperation;\nfunction makeDeleteStatement(filter, options) {\n    const op = {\n        q: filter,\n        limit: typeof options.limit === 'number' ? options.limit : 0\n    };\n    if (options.single === true) {\n        op.limit = 1;\n    }\n    if (options.collation) {\n        op.collation = options.collation;\n    }\n    if (options.hint) {\n        op.hint = options.hint;\n    }\n    return op;\n}\nexports.makeDeleteStatement = makeDeleteStatement;\n(0, operation_1.defineAspects)(DeleteOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION]);\n(0, operation_1.defineAspects)(DeleteOneOperation, [\n    operation_1.Aspect.RETRYABLE,\n    operation_1.Aspect.WRITE_OPERATION,\n    operation_1.Aspect.EXPLAINABLE,\n    operation_1.Aspect.SKIP_COLLATION\n]);\n(0, operation_1.defineAspects)(DeleteManyOperation, [\n    operation_1.Aspect.WRITE_OPERATION,\n    operation_1.Aspect.EXPLAINABLE,\n    operation_1.Aspect.SKIP_COLLATION\n]);\n//# sourceMappingURL=delete.js.map"]},"metadata":{},"sourceType":"script"}